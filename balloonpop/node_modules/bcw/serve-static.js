#!/usr/bin/env node
var basePath = process.cwd();
var http = require("http");
var path = require("path");
var fs = require("fs");
var mime = require("mime");
var path = require("path");
var port = 8080;

try {
  if (process.argv) {
    process.argv.find((a, i) => {
      if (a.includes("-p")) {
        port = Number(process.argv[i + 1]);
        return true;
      }
    });
  }
} catch (error) {
  console.error(error);
}

let server = http.createServer(function (req, res) {
  try {
    var decoded = decodeURI(req.url);
    var filename = path.join(process.cwd(), decoded);
    if (fs.statSync(filename).isDirectory()) filename += "/index.html";
    var exists = fs.existsSync(filename);

    if (!exists) {
      res.writeHead(404, { "Content-Type": "text/plain" });
      res.write("404 Not Found\n");
      res.end();
      return;
    }

    fs.readFile(filename, "binary", function (err, file) {
      if (err) {
        res.writeHead(500, { "Content-Type": "text/plain" });
        res.write(err + "\n");
        res.end();
        return;
      }

      res.writeHead(200, { "Content-Type": mime.getType(filename) });
      res.write(file, "binary");
      res.end();
    });
  } catch (e) {
    res.writeHead(404, { "Content-Type": "text/plain" });
    res.write("404 Not Found\n");
    res.end();
  }
});

function startServer() {
  server.listen(port, () => {
    console.log(
      `
Starting up server, serving ${basePath}
  Available on:
  http://localhost:${port}
`
    );
  });
}

startServer();
